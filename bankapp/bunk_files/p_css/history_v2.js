const sampleJson = JSON.stringify({
    "summaryByDate": [
        {
            "date": "2024-06-12",
            "totalAmount": -900
        },
        {
            "date": "2023-08-27",
            "totalAmount": 0
        },
        {
            "date": "2023-08-26",
            "totalAmount": 0
        },
        {
            "date": "2023-08-25",
            "totalAmount": 0
        },
        {
            "date": "2023-08-24",
            "totalAmount": 0
        },
        {
            "date": "2023-08-22",
            "totalAmount": -300
        },
        {
            "date": "2023-08-19",
            "totalAmount": 750
        },
        {
            "date": "2023-08-18",
            "totalAmount": 1000
        },
        {
            "date": "2023-08-17",
            "totalAmount": 1500
        },
        {
            "date": "2023-08-16",
            "totalAmount": 49500
        }
    ],
    "summaryByMonth": [
        {
            "month": "2023-08",
            "totalAmount": 52450
        },
        {
            "month": "2024-06",
            "totalAmount": -900
        }
    ],
    "rawData": [
        {
            "menuID": 8,
            "ID": 28,
            "Timestamp": "2024-06-12 09:46:43",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": -1000
        },
        {
            "menuID": 1,
            "ID": 1163,
            "Timestamp": "2024-06-12 09:46:03",
            "UserID": 99999,
            "Amount_entered": 100,
            "Amount": 100
        },
        {
            "menuID": 10,
            "ID": 1,
            "Timestamp": "2023-08-27 10:37:18",
            "UserID": 99999,
            "Amount_entered": 0,
            "Amount": 0
        },
        {
            "menuID": 10,
            "ID": 1,
            "Timestamp": "2023-08-26 10:37:18",
            "UserID": 99999,
            "Amount_entered": 0,
            "Amount": 0
        },
        {
            "menuID": 6,
            "ID": 142,
            "Timestamp": "2023-08-25 14:53:20",
            "UserID": 99999,
            "Amount_entered": -50,
            "Amount": 50
        },
        {
            "menuID": 6,
            "ID": 141,
            "Timestamp": "2023-08-25 14:47:38",
            "UserID": 99999,
            "Amount_entered": 50,
            "Amount": -50
        },
        {
            "menuID": 10,
            "ID": 1,
            "Timestamp": "2023-08-25 10:37:18",
            "UserID": 99999,
            "Amount_entered": 0,
            "Amount": 0
        },
        {
            "menuID": 1,
            "ID": 241,
            "Timestamp": "2023-08-24 15:53:47",
            "UserID": 99999,
            "Amount_entered": 0,
            "Amount": 0
        },
        {
            "menuID": 10,
            "ID": 1,
            "Timestamp": "2023-08-24 10:37:17",
            "UserID": 99999,
            "Amount_entered": 0,
            "Amount": 0
        },
        {
            "menuID": 6,
            "ID": 4,
            "Timestamp": "2023-08-22 18:40:17",
            "UserID": 99999,
            "Amount_entered": 300,
            "Amount": -300
        },
        {
            "menuID": 3,
            "ID": 9,
            "Timestamp": "2023-08-19 12:52:56",
            "UserID": 99999,
            "Amount_entered": 100,
            "Amount": -100
        },
        {
            "menuID": 1,
            "ID": 20,
            "Timestamp": "2023-08-19 12:52:35",
            "UserID": 99999,
            "Amount_entered": 500,
            "Amount": 500
        },
        {
            "menuID": 1,
            "ID": 19,
            "Timestamp": "2023-08-19 12:52:11",
            "UserID": 99999,
            "Amount_entered": 100,
            "Amount": 100
        },
        {
            "menuID": 1,
            "ID": 16,
            "Timestamp": "2023-08-19 08:54:49",
            "UserID": 99999,
            "Amount_entered": 250,
            "Amount": 250
        },
        {
            "menuID": 1,
            "ID": 15,
            "Timestamp": "2023-08-18 17:21:06",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": 1000
        },
        {
            "menuID": 1,
            "ID": 14,
            "Timestamp": "2023-08-17 12:55:00",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": 1000
        },
        {
            "menuID": 1,
            "ID": 13,
            "Timestamp": "2023-08-17 10:18:49",
            "UserID": 99999,
            "Amount_entered": 50000,
            "Amount": 50000
        },
        {
            "menuID": 1,
            "ID": 12,
            "Timestamp": "2023-08-17 10:16:53",
            "UserID": 99999,
            "Amount_entered": 1051000,
            "Amount": 1051000
        },
        {
            "menuID": 8,
            "ID": 3,
            "Timestamp": "2023-08-17 10:16:13",
            "UserID": 99999,
            "Amount_entered": 1000000,
            "Amount": -1000000
        },
        {
            "menuID": 3,
            "ID": 7,
            "Timestamp": "2023-08-17 10:15:05",
            "UserID": 99999,
            "Amount_entered": 100000,
            "Amount": -100000
        },
        {
            "menuID": 6,
            "ID": 3,
            "Timestamp": "2023-08-17 10:14:15",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": -1000
        },
        {
            "menuID": 2,
            "ID": 11,
            "Timestamp": "2023-08-17 10:13:27",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": -1000
        },
        {
            "menuID": 1,
            "ID": 11,
            "Timestamp": "2023-08-17 10:12:58",
            "UserID": 99999,
            "Amount_entered": 1000,
            "Amount": 1000
        },
        {
            "menuID": 1,
            "ID": 10,
            "Timestamp": "2023-08-17 08:57:06",
            "UserID": 99999,
            "Amount_entered": 500,
            "Amount": 500
        },
        {
            "menuID": 1,
            "ID": 9,
            "Timestamp": "2023-08-16 22:24:10",
            "UserID": 99999,
            "Amount_entered": 10000,
            "Amount": 10000
        },
        {
            "menuID": 1,
            "ID": 8,
            "Timestamp": "2023-08-16 22:21:20",
            "UserID": 99999,
            "Amount_entered": 20000,
            "Amount": 20000
        },
        {
            "menuID": 1,
            "ID": 7,
            "Timestamp": "2023-08-16 22:13:18",
            "UserID": 99999,
            "Amount_entered": 10000,
            "Amount": 10000
        },
        {
            "menuID": 2,
            "ID": 10,
            "Timestamp": "2023-08-16 18:14:14",
            "UserID": 99999,
            "Amount_entered": 500,
            "Amount": -500
        },
        {
            "menuID": 1,
            "ID": 6,
            "Timestamp": "2023-08-16 18:09:34",
            "UserID": 99999,
            "Amount_entered": 10000,
            "Amount": 10000
        },
        {
            "menuID": 2,
            "ID": 9,
            "Timestamp": "2023-08-16 18:09:11",
            "UserID": 99999,
            "Amount_entered": "",
            "Amount": 0
        },
        {
            "menuID": 3,
            "ID": 6,
            "Timestamp": "2023-08-16 18:08:51",
            "UserID": 99999,
            "Amount_entered": "",
            "Amount": 0
        }
    ]
})

const graph_row = [{
    "row": [
        {
            "label": "-5000"
        },
        {
            "label": "0"
        },
        {
            "label": "5000"
        },
        {
            "label": "10000"
        },
        {
            "label": "15000"
        },
        {
            "label": "20000"
        }
    ],
    "graph": [
        {
            "min": -5000,
            "max": 20000
        }
    ]
}]

const sampleData = JSON.parse(sampleJson);

console.log(graph_row[0].row);

// =====グラフ生成処理========================================================
// jsonData：JSONファイルデータ
// target：対象グラフ
// ==========================================================================

function createGraph(jsonData, target) {
    // キャンバス設定
    const graph_canvas = target.getElementsByClassName('bh_canvas')[0];
    const context = graph_canvas.getContext('2d');
    // グラフ領域
    graph_canvas.width = graph_canvas.offsetWidth;
    graph_canvas.height = graph_canvas.offsetHeight;
    const width = graph_canvas.offsetWidth;
    const height = graph_canvas.offsetHeight;

    // 縦軸の値1に対しての高さ
    const heightPerOne = height / (graph_row[0].graph[0].max - graph_row[0].graph[0].min);

    // グラフの横線を描画する
    // 一番下の横線は太さが2pxで、線端がroundのため1px調整
    drawStrokeLine(context, 1, height - 1, width - 1, height - 1, '#D5D5D5', 1, 'round', true);
    // 縦軸のデータの個数分繰り返す
    for (let i = 0; i < graph_row[0].row.length; i++) {
        // 値が0の要素か判定
        if (graph_row[0].row[i].label == Number(graph_row[0].row[graph_row[0].row.length - 1].label) + Number(graph_row[0].row[0].label)) {
            // 0の横線は太さが2pxで、線端がroundのため1px調整
            drawStrokeLine(context, 1, heightPerOne * (graph_row[0].row[i].label - graph_row[0].graph[0].min), width - 1, heightPerOne * (graph_row[0].row[i].label - graph_row[0].graph[0].min), '#D5D5D5', 2, 'round', false);
        } else {
            drawStrokeLine(context, 0, heightPerOne * (graph_row[0].row[i].label - graph_row[0].graph[0].min), width, heightPerOne * (graph_row[0].row[i].label - graph_row[0].graph[0].min), '#D5D5D5', 1, 'round', true);
        }
    }

    // 棒グラフを描画する
    const good = target.getElementsByClassName('bh_graph_goodText')[0].offsetWidth;
    const bad = target.getElementsByClassName('bh_graph_badText')[0].offsetWidth;
    const fluctuationArea = width - good - bad;   // グラフの変動領域

    // 各横軸ラベルのX座標を左から順に配列に格納
    const XCoordinate = getXCoordinate(jsonData, fluctuationArea, good);

    // 棒グラフの色を設定する
    // 横軸のデータの個数分繰り返す
    for (let i = 0; i < jsonData.length; i++) {
        let color;
        // 正の値なら青に、負の値なら赤に設定
        if (jsonData.column[i].data > 0) {
            color = '#5ea1c5';
        } else if (jsonData.column[i].data < 0) {
            color = '#e84f4c';
        }

        // 棒グラフの縦軸の座標（Y座標）
        let Ycoordinate = heightPerOne * (graph_row[0].graph[0].max - Math.ceil(jsonData.column[i].data / 100) * 100);
        // データが最大値以上か判定
        if (jsonData.column[i].data > graph_row[0].graph[0].max - 2) {
            // 上限値に設定
            // グラフが一番上の横線と重ならないように2px調整
            Ycoordinate = 2;
        }
        // データが最小値以下か判定
        if (jsonData.column[i].data < graph_row[0].graph[0].min + 2) {
            // 下限値に設定
            // グラフが一番下の横線と重ならないように2px調整
            Ycoordinate = heightPerOne * (graph_row[0].row[graph_row[0].row.length - 1].label - graph_row[0].graph[0].min) - 2;
        }
        // データが500以上0以上か判定
        if (jsonData.column[i].data <= 500 && jsonData.column[i].data > 0) {
            Ycoordinate = heightPerOne * (graph_row[0].graph[0].max - 500);
        }
        // データが-500以上0以下か判定
        if (jsonData.column[i].data >= -500 && jsonData.column[i].data < 0) {
            Ycoordinate = heightPerOne * (graph_row[0].graph[0].max + 500);
        }

        // データが0以外の場合、棒グラフの線を描画する
        if (jsonData.column[i].data != 0) {
            // 2pxで描画するため7px調整、横線に重ならないように調整（1と3の部分）
            drawTwoCornerRoundedLine(context, XCoordinate[i] + width / 60, heightPerOne * (graph_row[0].row[4].label - graph_row[0].graph[0].min), XCoordinate[i] - width / 60, Ycoordinate + 1, 2, color, color, 2, false);
        }

        // ペンギンの位置指定
        const box = target.parentElement.getElementsByClassName('bh_box')[0];
        if (jsonData.column[9].data >= 0) {
            box.style.top = Ycoordinate + 'px';
            box.style.left = XCoordinate[9] * 0.93 + 40 + 'px';
        } else if (jsonData.column[9].data < 0) {
            box.style.top = Ycoordinate + 28 - fluctuationArea / 24 + 'px';
            box.style.left = XCoordinate[9] + 30 - fluctuationArea / 24 + 'px';
        }

        // ペンギンの大きさ指定
        box.style.height = fluctuationArea / 7 + 'px';
        box.style.width = fluctuationArea / 7 + 'px';
    }

    // 背景の幅指定
    const backGroundImage = target.parentElement.getElementsByClassName('bh_image')[0];
    backGroundImage.firstElementChild.style.width = graph_canvas.width + 'px';
}

// ====線を引く===============================================================
// context：対象キャンバス
// startX：開始点のX座標
// startY：開始点のY座標
// endX：終了点のX座標
// endY：終了点のY座標
// color：線の色
// size：線の太さ
// lineCap：線端の種類
// dotLine：破線か否か
// ==========================================================================
function drawStrokeLine(context, startX, startY, endX, endY, color, size, lineCap, dotLine) {
    context.beginPath();
    context.strokeStyle = color;
    context.lineWidth = size;
    context.lineCap = lineCap;
    // 破線か否か判定
    if (dotLine) {
        context.setLineDash([2, 1]);
    } else {
        context.setLineDash([]);
    }
    context.moveTo(startX, startY);
    context.lineTo(endX, endY);
    context.stroke();
}

// =====各横軸ラベルのX座標設定================================================
// jsonData：JSONファイルデータ
// fluctuationArea：変動領域
// margin：左右余白
// ==========================================================================
function getXCoordinate(jsonData, fluctuationArea, margin) {
    // 一つの横軸ラベルの幅
    const memWidth = fluctuationArea / jsonData.length;
    const memWidthHalf = memWidth / 2;
    // 描画位置（X座標）を順に配列に格納する
    let XCoordinate = [];
    for (let i = 0; i < jsonData.length; i++) {
        XCoordinate.push(memWidthHalf + margin + (memWidth * i));
    }
    return XCoordinate;
}

// ====2つの角が角丸の線を引く================================================
// context：対象キャンバス
// x1：開始点のX座標
// y1：開始点のY座標
// x2：開始点の対角のX座標
// y2：開始点の対角のY座標
// strokeColor：線の色
// fillColor：塗りつぶす色
// size：線の太さ
// dotLine：破線か否か
// ==========================================================================
function drawTwoCornerRoundedLine(context, x1, y1, x2, y2, borderRadius, strokeColor, fillColor, size, dotLine) {
    context.beginPath();
    context.strokeStyle = strokeColor;
    context.fillStyle = fillColor;
    context.lineWidth = size;
    // 破線か否か判定
    if (dotLine) {
        context.setLineDash([6, 4]);
    } else {
        context.setLineDash([]);
    }
    context.moveTo(x1, y1);
    context.lineTo(x2, y1);
    context.arcTo(x2, y2, x1, y2, borderRadius);
    context.arcTo(x1, y2, x1, y1, borderRadius);
    context.closePath();
    context.fill();
    context.stroke();
}

// =====Element生成==========================================================
// jsonData：JSONファイルデータ
// target：対象グラフ
// ==========================================================================
function createGraph_Element(jsonData, target) {

    // X軸ラベルの作成
    const XlabelArea = document.createElement('div');
    XlabelArea.classList.add('bh_graph_XlabelArea');

    // 「Good」テキスト
    const goodText = document.createElement('div');
    goodText.classList.add('bh_graph_goodText');
    // タイポ
    let goodText_typo = document.createElement('p');
    goodText_typo.innerText = 'むかし';
    goodText.appendChild(goodText_typo);
    XlabelArea.appendChild(goodText);

    // X軸ラベル
    const Xlabel = document.createElement('div');
    Xlabel.classList.add('bh_graph_Xlabel');
    for (let i = 0; i < jsonData.length; i++) {
        // X軸のbar
        const Xlabel_div = document.createElement('div');
        const Xlabel_bar = document.createElement('div');
        Xlabel_bar.classList.add('bh_graph_bar');
        // Xlabel_bar.style.backgroundColor = jsonData.column[i].color;

        Xlabel_div.appendChild(Xlabel_bar);
        Xlabel.appendChild(Xlabel_div);
    }
    XlabelArea.appendChild(Xlabel);

    // 「Bad」テキスト
    const badText = document.createElement('div');
    badText.classList.add('bh_graph_badText');
    // タイポ
    let badText_typo = document.createElement('p');
    badText_typo.innerText = 'いま';
    badText.appendChild(badText_typo);
    XlabelArea.appendChild(badText);
    target.appendChild(XlabelArea);

    // Y軸ラベルの作成
    const YlabelArea = document.createElement('div');
    YlabelArea.classList.add('bh_graph_YlabelArea');
    for (let i = graph_row[0].row.length - 1; i >= 0; i--) {
        const Ylabel = document.createElement('div');
        Ylabel.classList.add('bh_graph_Ylabel');

        // タイポ
        let Ylabel_typo = document.createElement('p');
        Ylabel_typo.className = 'bh_yLabel';
        Ylabel_typo.innerText = graph_row[0].row[i].label;

        Ylabel.appendChild(Ylabel_typo);
        YlabelArea.appendChild(Ylabel);
    }
    target.appendChild(YlabelArea);
}

// y軸ラベルの高さ調整
function setYlabelHeight(jsondata, height, target) {
    for (let i = 0; i < graph_row[0].row.length; i++) {
        target.getElementsByClassName('bh_graph_Ylabel')[i].style.height = height / (graph_row[0].row.length - 1) + 'px';
    }
}

const graph = document.getElementsByClassName('bh_graph');
// ページ読み込み時にイベント登録
window.addEventListener('DOMContentLoaded', function () {
    // グラフ生成処理呼び出し
    createGraph_Element(sampleData.summaryByDate, graph[0]);
    createGraph(sampleData.summaryByDate, graph[0]);
    setYlabelHeight(sampleData.summaryByDate, graph[0].getElementsByClassName('bh_canvas')[0].offsetHeight, graph[0]);
    createGraph_Element(sampleData.summaryByMonth, graph[1]);
    createGraph(sampleData.summaryByMonth, graph[1]);
    setYlabelHeight(sampleData.summaryByMonth, graph[1].getElementsByClassName('bh_canvas')[0].offsetHeight, graph[1]);

});
// リサイズ時にイベント登録
window.addEventListener('resize', function () {
    createGraph(sampleData.summaryByDate, graph[0]);
    setYlabelHeight(sampleData.summaryByDate, graph[0].getElementsByClassName('bh_canvas')[0].offsetHeight, graph[0]);
    createGraph(sampleData.summaryByMonth, graph[1]);
    setYlabelHeight(sampleData.summaryByMonth, graph[1].getElementsByClassName('bh_canvas')[0].offsetHeight, graph[1]);
});



/*** メニュー画面からidと残高を引継ぎなど***/
function formatNumberWithCommas(number) {
    // 数値を文字列に変換し、逆順にして桁区切りを追加する
    const strNumber = number.toString();
    let formattedNumber = '';

    for (let i = strNumber.length - 1, count = 0; i >= 0; i--, count++) {
        formattedNumber = strNumber[i] + formattedNumber;
        if (count !== 0 && count % 3 === 0 && i !== 0) {
            formattedNumber = ',' + formattedNumber; // 3桁ごとにカンマを追加
        }
    }

    return formattedNumber;
}




/* DBから値を取得して表示 */
window.addEventListener('DOMContentLoaded', function () {
    // ローダーの生成
    createLoader('よみこみ<ruby>中<rt>ちゅう</rt></ruby>');

    // IDの認証
    const userId = getQueryParams('id');
    const nameDeployUrl = 'https://script.google.com/macros/s/AKfycbyZktHo5yEeM3MRwe8CQ_Ym4c8MNV1GIM1qF01ViLEgCFV4l2sSYiepJkVac2so4f4L/exec';
    let queryParams = {
        id: userId
    };
    const newNameUrl = setQueryParams(nameDeployUrl, queryParams);
    fetch(newNameUrl).then(function (nameResponse) {
        // レスポンスデータをJSON形式に変換
        return nameResponse.json();
    }).then(function (nameData) {
        const name = nameData.content;
        const nameElement = document.getElementById('bh_userName');
        nameElement.innerText = name;
    }).then(function () {
        const amountDeployUrl = 'https://script.google.com/macros/s/AKfycbxWNd3mbrOy7feXkLnWgfrWvGrSXX9jC_yebsJ-0LfYnWeiQfl41s1Fz_0xTim8m3OhnA/exec';
        const newAmountUrl = setQueryParams(amountDeployUrl, queryParams);
        fetch(newAmountUrl).then(function (amountResponse) {
            // レスポンスデータをJSON形式に変換
            return amountResponse.json();
        }).then(function (amountData) {
            const amount = Number(amountData.content);
            const amoountElement = document.getElementById('bh_amuntKids');
            amoountElement.innerText = formatNumberWithCommas(amount);
        }).then(function () {
            // ローダーの非表示
            hideLoader();
        }).catch(function (error) {
            window.alert('ネットワークにせつぞくされているかかくにんしてください');
        });
    }).catch(function (error) {
        // ローダーの非表示
        hideLoader();
        window.alert('ネットワークにせつぞくされているかかくにんしてください');
    });
});

/* ブラウザバック時のローダー非表示 */
window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
        hideLoader();
    }
});



// プルダウン
// select要素からリスト生成
function makePull() {
    // selestタグ取得
    const pull_select = document.getElementsByClassName('bh_pullDown_graphSelector_select');

    // 既にUlに作成されているliを削除
    const collectionListUl = document.getElementsByClassName('bh_pullDown_graphSelector_list');
    for (let i = 0; i < pull_select.length; i++) {
        if (collectionListUl[i].hasChildNodes()) {
            collectionListUl[i].innerHTML = '';
        }
    }

    //プルダウンメニューをすべてに対して処理
    for (let i = 0; i < pull_select.length; i++) {

        //プルダウンメニュー内のoptionタグからliタグを生成
        for (let j = 0; j < pull_select[i].length; j++) {

            // 作成するli
            const newLi = document.createElement('li');
            newLi.setAttribute('tabindex', '0');
            // 各リストの下線用div
            const listBorderDiv = document.createElement("div");
            // liタグ内に追加するチェックアイコン用のdiv
            const checkDiv = document.createElement("div");
            // liタグ内に追加する選択項目テキスト用のp
            const listP = document.createElement('p');
            listP.className = 'bh_typo_bodyM bh_typo_BLK10 bh_typo_align_left';

            // li
            // 選択されているoptionの場合、選択されていることを明示するクラス名を追加
            if (pull_select[i].options[j].value == pull_select[i].value) {
                newLi.classList.add("bh_pullDown_graphSelector_selected");
                listP.className = 'bh_typo_headerS bh_typo_BLK10 bh_typo_align_left';
            }
            newLi.dataset.value = pull_select[i].options[j].value;

            // 下線用div
            listBorderDiv.classList.add("bh_pullDown_graphSelector_listBorder");
            // チェックアイコン用div
            checkDiv.classList.add("bh_pullDown_graphSelector_icon_check");

            // チェックアイコンsvg生成
            const checkSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            checkSvg.setAttribute("width", "24");
            checkSvg.setAttribute("height", "24");
            checkSvg.setAttribute("viewbox", "0 0 24 24");
            checkSvg.setAttribute("fill", "none");
            const checkSvgPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            checkSvgPath.setAttribute('d', 'M7.80859 12.4721L10.1657 14.8572L16.1895 8.76196');
            checkSvgPath.setAttribute('stroke', '#008673');
            checkSvgPath.setAttribute('stroke-width', 2);
            checkSvgPath.setAttribute('stroke-linecap', 'round');
            checkSvgPath.setAttribute('stroke-linejoin', 'round');
            checkSvg.appendChild(checkSvgPath);
            // divにチェックアイコンsvg追加
            checkDiv.appendChild(checkSvg);
            // プルダウンメニューのoptionタグのテキストをliのpに反映
            listP.innerHTML = pull_select[i].options[j].innerHTML;
            // チェックアイコンsvgの親div追加
            listBorderDiv.appendChild(checkDiv);
            // P追加
            listBorderDiv.appendChild(listP);

            // プルダウンメニューのoptionに凡例フラグがある場合にliに凡例アイコン追加
            if (pull_select[i].options[j].classList.contains('bh_pullDown_graphSelector_hanrei_icon')) {
                // liに追加する凡例アイコン用のdiv
                const hanreiDiv = document.createElement("div");
                hanreiDiv.classList.add("bh_pullDown_graphSelector_icon_hanrei");
                // liに追加する凡例アイコンsvg生成
                const hanreiSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
                hanreiSvg.setAttribute("width", "24");
                hanreiSvg.setAttribute("height", "24");
                hanreiSvg.setAttribute("viewbox", "0 0 24 24");
                hanreiSvg.setAttribute("fill", "none");
                const hanreiSvgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                hanreiSvgRect.setAttribute("x", "4");
                hanreiSvgRect.setAttribute("y", "4");
                hanreiSvgRect.setAttribute("width", "16");
                hanreiSvgRect.setAttribute("height", "16");
                hanreiSvgRect.setAttribute("rx", "8");
                hanreiSvgRect.setAttribute("fill", "#E53935");
                const hanreiSvgPath1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                hanreiSvgPath1.setAttribute("d", "M11.9945 17C12.5628 17 13 16.5625 13 16C13 15.4271 12.5628 15 11.9945 15C11.4262 15 11 15.4271 11 16C11 16.5625 11.4262 17 11.9945 17Z");
                hanreiSvgPath1.setAttribute("fill", "white");
                const hanreiSvgPath2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                hanreiSvgPath2.setAttribute("d", "M12.9324 8.91535L12.6848 13.3524C12.6645 13.7157 12.3639 14 12 14C11.6361 14 11.3355 13.7157 11.3152 13.3524L11.0676 8.91535L11.0353 7.99938C11.016 7.45323 11.4535 7 12 7C12.5465 7 12.984 7.45323 12.9647 7.99938L12.9324 8.91535Z");
                hanreiSvgPath2.setAttribute("fill", "white");
                hanreiSvg.appendChild(hanreiSvgRect);
                hanreiSvg.appendChild(hanreiSvgPath1);
                hanreiSvg.appendChild(hanreiSvgPath2);
                // 凡例アイコンdivに凡例アイコンsvg追加
                hanreiDiv.appendChild(hanreiSvg);
                // liに凡例アイコンdivの追加
                listBorderDiv.appendChild(hanreiDiv);
            }
            // 下線用div追加
            newLi.appendChild(listBorderDiv);

            // optionがhiddenならliを表示しない
            // optionタグにhiddenが設定されているか判定
            if (pull_select[i].options[j].hidden) {
                newLi.style.display = "none";
            }

            // li追加
            document.getElementsByClassName('bh_pullDown_graphSelector_list')[i].appendChild(newLi);

            // menuの初期表示テキストとして選択されている項目のテキストを表示
            if (newLi.classList.contains('bh_pullDown_graphSelector_selected')) {
                document.getElementsByClassName('bh_pullDown_graphSelector_menu_selected')[i].innerHTML = listBorderDiv.innerHTML.replace('bh_typo_BLK10', 'bh_typo_BLUE').replace('bh_typo_align_left', 'bh_typo_align_left bh_typo_oneLine');
            }

            // リスト押下時にイベント登録
            newLi.addEventListener('click', clickPullDownSelectList);

            // キー操作が行われたら処理を実行
            newLi.addEventListener('keydown', function (e) {
                // クリックイベントの生成
                if (c_isbrowserIE()) {
                    clickEvent = document.createEvent('Event');
                    clickEvent.initEvent('click', false, true);
                } else {
                    clickEvent = new Event('click');
                }

                // EnterキーもしくはSpace押下で該当項目を選択する
                // keyCode : "13" （Enter）
                if (e.keyCode == "13") {
                    this.dispatchEvent(clickEvent);
                }
            });
        }
    }
}

/* プルダウンの開閉状態を設定 */
function clickPullDown() {
    // 対象のプルダウンを設定
    const parentPullDown = this.parentElement;

    // 押下したプルダウン以外はすべて閉じる
    const pulldown = document.getElementsByClassName('bh_pullDown_graphSelector');
    for (let i = 0; i < pulldown.length; i++) {
        if ((pulldown[i] != parentPullDown) && (pulldown[i].classList.contains('bh_pullDown_graphSelector_isOpen'))) {
            pulldown[i].classList.remove('bh_pullDown_graphSelector_isOpen');
        }
    }

    // 開閉フラグの判定
    if (parentPullDown.classList.contains('bh_pullDown_graphSelector_isOpen')) {
        // 開いている状態なら閉じる
        // openフラグの削除
        parentPullDown.classList.remove('bh_pullDown_graphSelector_isOpen');
    } else {
        // 閉じている状態なら開く
        // リストの表示位置・高さを指定する関数を呼び出す
        setListBox(parentPullDown);
        // openフラグの追加
        parentPullDown.classList.add('bh_pullDown_graphSelector_isOpen');
    }
}

/* リストボックスの高さを取得し表示位置を設定 */
function setListBox(targetElement) {
    // 各パーツを変数化
    // 対象のプルダウンメニュー
    const targetPullDownMenu = targetElement.getElementsByClassName('bh_pullDown_graphSelector_menu')[0];
    // 対象のリストボックス
    const listBox = targetElement.getElementsByClassName('bh_pullDown_graphSelector_listBox')[0];
    // リストボックスに含まれる凡例行
    const hanrei = listBox.getElementsByClassName('bh_pullDown_graphSelector_hanrei');

    // 画面の高さ取得
    const windowHeight = document.documentElement.clientHeight;
    // プルダウンメニューの画面内のtop位置取得
    const pullDownMenuTop = targetPullDownMenu.getBoundingClientRect().top;
    // プルダウンメニューの画面内のbottom位置取得
    const pullDownMenuBottom = targetPullDownMenu.getBoundingClientRect().bottom;
    // プルダウンメニューの高さ
    const pullDownMenuHeight = targetPullDownMenu.offsetHeight;
    // リストボックスとプルダウンメニュー間の余白(8px)
    const listMargin = 8;
    // リストボックスの表示位置
    const listBoxPosition = pullDownMenuHeight + listMargin;
    // 上に伸びる際のリスト表示可能エリア
    const listAreaUpper = pullDownMenuTop - (listMargin * 2);
    // 下に伸びる際のリストの表示可能エリア
    const listArea = windowHeight - (pullDownMenuBottom + (listMargin * 2));

    // プルダウンの上下余白を比較
    if (listAreaUpper > listArea) {
        // プルダウンエリア最上部から余白8px上に表示
        listBox.style.bottom = listBoxPosition + "px";
        listBox.style.top = '';

        // リストボックスの高さの最大値を設定
        listBox.style.maxHeight = listAreaUpper + "px";
    } else {
        // 通常は下に伸びる
        // プルダウンエリア最上部からメニューの高さ＋余白8px下に表示
        listBox.style.top = listBoxPosition + "px";
        listBox.style.bottom = null;

        // リストボックスの高さの最大値を設定
        listBox.style.maxHeight = listArea + "px";
    }
}

/* リストの選択状態を設定 */
function clickPullDownSelectList() {
    // フラグの判定
    if (!this.classList.contains('bh_pullDown_graphSelector_selected')) {
        // 各パーツを変数化
        // 全リスト
        const list = this.parentElement.children;
        // 対象プルダウン
        const targetElement = this.parentElement.parentElement.parentElement;
        // 対象プルダウンメニューのテキストエリア
        const pullDownMenuText = targetElement.getElementsByClassName('bh_pullDown_graphSelector_menu_selected')[0];
        // プルダウンメニュー
        const thisSelect = targetElement.getElementsByClassName('bh_pullDown_graphSelector_select')[0];

        // リスト選択有無フラグ設定削除
        for (let i = 0; i < list.length; i++) {
            list[i].classList.remove('bh_pullDown_graphSelector_selected');
            list[i].innerHTML = list[i].innerHTML.replace('bh_typo_headerS', 'bh_typo_bodyM');
        }
        // 選択フラグの設定
        this.classList.add('bh_pullDown_graphSelector_selected');
        this.innerHTML = this.innerHTML.replace('bh_typo_bodyM', 'bh_typo_headerS');

        // プルダウンメニューのテキスト設定
        pullDownMenuText.innerHTML = this.getElementsByClassName('bh_pullDown_graphSelector_listBorder')[0].innerHTML.replace('bh_typo_BLK10', 'bh_typo_BLUE').replace('bh_typo_align_left', 'bh_typo_align_left bh_typo_oneLine');

        // optionタグにselectedを設定
        for (let i = 0; i < thisSelect.length; i++) {
            if (thisSelect.options[i].value == this.dataset.value) {
                thisSelect.options[i].selected = true;

                // onchangeイベント発火
                if (thisSelect.onchange) {
                    thisSelect.onchange();
                }
            }
        }

        // 選択したらリストを非表示
        // openフラグの削除
        targetElement.classList.remove('bh_pullDown_graphSelector_isOpen');
    }
}

// 画面読み込み時にプルダウンリスト生成
window.addEventListener('DOMContentLoaded', makePull);

// コレクションを取得
const pullDownMenu = document.getElementsByClassName('bh_pullDown_graphSelector_menu');
// プルダウンメニュー押下時にイベント登録
for (let i = 0; i < pullDownMenu.length; i++) {
    pullDownMenu[i].addEventListener('click', clickPullDown); // クリック時に見出し部分と内容部分の高さを設定、アイコン部分のクラスを入れ替え
}

// コレクションを取得
const pullDownOutSideClose = document.getElementsByClassName('bh_pullDown_graphSelector_outSideClose');

// エリア外押下にイベント登録
for (let i = 0; i < pullDownOutSideClose.length; i++) {
    pullDownOutSideClose[i].addEventListener('click', clickPullDown); // クリック時に見出し部分と内容部分の高さを設定、アイコン部分のクラスを入れ替え
}

// リサイズ
window.addEventListener('resize', function () {
    const openMenu = document.getElementsByClassName('bh_pullDown_graphSelector_isOpen');
    for (let i = 0; i < openMenu.length; i++) {
        setListBox(openMenu[i]);
    }
});

window.addEventListener('DOMContentLoaded', function () {
    const pullDownList = document.getElementsByClassName('bh_pullDown_graphSelector');

    for (let i = 0; i < pullDownList.length; i++) {
        let clickEvent;
        // キー操作が行われたら処理を実行
        pullDownList[i].children[1].addEventListener('keydown', function (e) {
            // クリックイベントの生成
            if (c_isbrowserIE()) {
                clickEvent = document.createEvent('Event');
                clickEvent.initEvent('click', false, true);
            } else {
                clickEvent = new Event('click');
            }

            // EnterキーもしくはSpace押下で該当項目を選択する
            // keyCode : "13" （Enter）
            if (e.keyCode == "13") {
                this.dispatchEvent(clickEvent);
            }
        });
    }

})

// グラフ非表示化
window.addEventListener('DOMContentLoaded', function () {
    graphArea = document.getElementsByClassName('bh_graphArea');
    graphArea[1].classList.add('bh_display_none');
})


// プルダウン変更時
function changePulldown() {
    graphMenu = document.getElementsByClassName('bh_pullDown_graphSelector_select')[0];
    graphArea = document.getElementsByClassName('bh_graphArea');

    for (let i = 0; i < graphMenu.length; i++) {
        graphArea[i].classList.remove('bh_display_none');
    }
    if (graphMenu.value == "day") {
        graphArea[1].classList.add('bh_display_none');
    } else {
        graphArea[0].classList.add('bh_display_none');
    }
}


// 取引履歴表示
window.addEventListener('DOMContentLoaded', function () {
    const historyArea = document.getElementsByClassName('bh_transHistoryArea')[0];
    historyArea.appendChild(makeHistoryList(transData[0]));
})

// 履歴一覧を作成する関数
function makeHistoryList(data) {
    if (data.transData[0]) {
        // リスト要素の作成
        const historyList = document.createElement("ul");
        historyList.classList.add('bh_historyList');

        for (let i = 0; i < data.transData.length; i++) {
            // 中身の作成
            const historyUnit = document.createElement("li");
            historyUnit.classList.add('bh_historyUnit');

            // タイムスタンプエリア
            const timestampArea = document.createElement("div");
            timestampArea.classList.add('bh_history_timestampArea');
            // 日付エリア
            const dateArea = document.createElement("div");
            dateArea.classList.add('bh_history_date');
            const date = document.createElement("p");
            date.classList.add('bh_typo_timestamp');
            const monthValue = data.transData[i].transTime.substr(5, 2);
            const dayValue = data.transData[i].transTime.substr(8, 2);
            const dateValue = monthValue + "月" + dayValue + "日";
            date.innerText = dateValue;
            dateArea.appendChild(date);
            // 時間エリア
            const timeArea = document.createElement("div");
            timeArea.classList.add('bh_history_time');
            const time = document.createElement("p");
            time.classList.add('bh_typo_timestamp');
            const hourValue = data.transData[i].transTime.substr(11, 2);
            const minuteValue = data.transData[i].transTime.substr(14, 2);
            const timeValue = hourValue + "時" + minuteValue + "分";
            time.innerText = timeValue;
            timeArea.appendChild(time);
            // 子要素の格納
            timestampArea.appendChild(dateArea);
            timestampArea.appendChild(timeArea);

            // 明細エリア
            const detailArea = document.createElement("div");
            detailArea.classList.add('bh_history_detailArea');
            // メニューエリア
            const menuArea = document.createElement("div");
            menuArea.classList.add('bh_history_menu');
            const menu = document.createElement("p");
            menu.classList.add('bh_typo_historyDetail');
            switch (data.transData[i].menuId) {
                case "1":
                    menu.innerText = "おかねをあずける";
                    break;
                case "2":
                    menu.innerText = "おかねをひきだす";
                    break;
                case "3":
                case "4":
                case "5":
                    menu.innerText = "おきゅうりょうをはらう";
                    break;
                case "6":
                case "7":
                    menu.innerText = "ぜいきんをはらう";
                    break;
                case "8":
                case "9":
                    menu.innerText = "あそび大学にあげる";
                    break;
                case "10":
                case "11":
                    menu.innerText = "土地代をはらう";
                    break;
                default:
                    menu.innerText = "読み込めません"
            }
            menuArea.appendChild(menu);
            // 金額エリア
            const valueArea = document.createElement("div");
            valueArea.classList.add('bh_history_value');
            const value = document.createElement("p");
            value.classList.add('bh_typo_historyValue');
            switch (data.transData[i].menuId) {
                case "1":
                    value.innerText = "+" + data.transData[i].transAmount;
                    break;
                case "2":
                case "3":
                case "4":
                case "5":
                case "6":
                case "7":
                case "8":
                case "9":
                case "10":
                case "11":
                    value.innerText = "-" + data.transData[i].transAmount;
                    break;
                default:
                    value.innerText = data.transData[i].transAmount;
            }
            valueArea.appendChild(value);
            const kids = document.createElement("p");
            kids.classList.add('bh_typo_historyDetail');
            kids.innerText = "キッズ";
            valueArea.appendChild(kids);
            // 子要素の格納
            detailArea.appendChild(menuArea);
            detailArea.appendChild(valueArea);

            // 履歴要素完成
            historyUnit.appendChild(timestampArea);
            historyUnit.appendChild(detailArea);

            // リストに格納
            historyList.appendChild(historyUnit);

            // 仕切り線
            if (i < data.transData.length - 1) {
                const borderArea = document.createElement('li');
                borderArea.classList.add('bh_historyPartition');
                const borderLine = document.createElement('hr');
                borderLine.classList.add('bh_partition_dashed');
                borderArea.appendChild(borderLine);
                historyList.appendChild(borderArea);
            }
        }
        return historyList;
    }
}

// 履歴がある場合非表示メッセージを外す
window.addEventListener('DOMContentLoaded', function () {
    const historyArea = document.getElementsByClassName('bh_transHistoryArea')[0];
    if (transData[0].transData[0]) {
        historyArea.firstElementChild.classList.add('bh_display_none');
    }
})